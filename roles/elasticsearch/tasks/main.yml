---
- name: Perform yum update of all packages
  yum:
    name: '*'
    state: latest

- name: Import Elastic GPG Key
  rpm_key:
    key: https://artifacts.elastic.co/GPG-KEY-elasticsearch
    state: present

- name: Add Elastic 7.x RPM Repo
  yum_repository:
    name: elasticsearch
    description: Elasticsearch repository for 7.x packages
    baseurl: https://artifacts.elastic.co/packages/7.x/yum
    gpgcheck: true
    gpgkey: https://artifacts.elastic.co/GPG-KEY-elasticsearch
    enabled: yes

- name: Install Elastic
  yum:
    name: elasticsearch
    state: present
    update_cache: true

- name: Configure Elastic vote node
  when: inventory_hostname in groups['elk_master']
  template:
    src: templates/elastic-vote.yml.j2
    dest: /etc/elasticsearch/elasticsearch.yml

- name: Configure Elastic data nodes
  when: inventory_hostname in groups['elk_worker']
  template:
    src: templates/elastic-main.yml.j2
    dest: /etc/elasticsearch/elasticsearch.yml

# - name: Configure JVM heap size
#   template:
#     src: templates/jvm-heap-2g.j2
#     dest: /etc/elasticsearch/jvm.options.d/jvm-options

- name: Open firewall ports
  shell: firewall-cmd --add-port={9200/tcp,9300/tcp} --permanent && firewall-cmd --reload

- name: Start Elasticsearch service
  systemd:
    name: elasticsearch
    state: started
    enabled: yes